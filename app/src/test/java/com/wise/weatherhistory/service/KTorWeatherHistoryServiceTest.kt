package com.wise.weatherhistory.service

import com.wise.weatherhistory.model.Location
import com.wise.weatherhistory.model.WeatherData
import io.ktor.client.engine.mock.MockEngine
import io.ktor.client.engine.mock.respond
import io.ktor.http.HttpHeaders
import io.ktor.http.HttpMethod
import io.ktor.http.headersOf
import kotlinx.coroutines.runBlocking
import org.junit.Assert.assertEquals
import org.junit.Test
import java.time.LocalDate
import java.time.LocalDateTime
import java.time.format.DateTimeFormatter

class KTorWeatherHistoryServiceTest {
    private val mockEngine = MockEngine {
        respond(
            JSON_RESPONSE,
            headers = headersOf(HttpHeaders.ContentType, "application/json")
        )
    }
    private val location = Location(123.3f,3456.0f,78.0f,"name","country","region")
    private val range = LocalDate.of(2024,2,1)..LocalDate.of(2024,2,10)

    @Test
    fun `parameters is passed correctly`() {
        runBlocking {
            KTorWeatherHistoryService(buildHttpClient( mockEngine)).getWeatherData(location, range)

            mockEngine.requestHistory.first().also {request ->
                assertEquals(request.method, HttpMethod.Get)
                mapOf(
                    "latitude" to location.latitude.toString(),
                    "longitude" to location.longitude.toString(),
                    "hourly" to "temperature_2m,apparent_temperature,precipitation,rain,showers,snowfall,snow_depth",
                    "start_date" to DateTimeFormatter.ISO_DATE.format(range.start),
                    "end_date" to DateTimeFormatter.ISO_DATE.format(range.endInclusive)
                ).forEach { (key, value) ->
                    assertEquals(request.url.parameters[key], value)
                }
            }
        }
    }

    @Test
    fun `response is passed correctly`() {
        runBlocking {
            val response = KTorWeatherHistoryService(buildHttpClient( mockEngine)).getWeatherData(location, range)
            assertEquals(response.size, 120)
            assertEquals(response[119],
                WeatherData(time= LocalDateTime.of(2024,3,1,23,0), temperature=7.1f, precipitation=0.1f, rain=0.1f, showers=0.0f, snowfall=0.0f, snowDepth=0.0f)
            )
        }
    }


    companion object {
        const val JSON_RESPONSE = """
            {"latitude":52.52,"longitude":13.419998,"generationtime_ms":0.12099742889404297,"utc_offset_seconds":0,"timezone":"GMT","timezone_abbreviation":"GMT","elevation":38.0,"hourly_units":{"time":"iso8601","temperature_2m":"°C","apparent_temperature":"°C","precipitation":"mm","rain":"mm","showers":"mm","snowfall":"cm","snow_depth":"m"},"hourly":{"time":["2024-02-26T00:00","2024-02-26T01:00","2024-02-26T02:00","2024-02-26T03:00","2024-02-26T04:00","2024-02-26T05:00","2024-02-26T06:00","2024-02-26T07:00","2024-02-26T08:00","2024-02-26T09:00","2024-02-26T10:00","2024-02-26T11:00","2024-02-26T12:00","2024-02-26T13:00","2024-02-26T14:00","2024-02-26T15:00","2024-02-26T16:00","2024-02-26T17:00","2024-02-26T18:00","2024-02-26T19:00","2024-02-26T20:00","2024-02-26T21:00","2024-02-26T22:00","2024-02-26T23:00","2024-02-27T00:00","2024-02-27T01:00","2024-02-27T02:00","2024-02-27T03:00","2024-02-27T04:00","2024-02-27T05:00","2024-02-27T06:00","2024-02-27T07:00","2024-02-27T08:00","2024-02-27T09:00","2024-02-27T10:00","2024-02-27T11:00","2024-02-27T12:00","2024-02-27T13:00","2024-02-27T14:00","2024-02-27T15:00","2024-02-27T16:00","2024-02-27T17:00","2024-02-27T18:00","2024-02-27T19:00","2024-02-27T20:00","2024-02-27T21:00","2024-02-27T22:00","2024-02-27T23:00","2024-02-28T00:00","2024-02-28T01:00","2024-02-28T02:00","2024-02-28T03:00","2024-02-28T04:00","2024-02-28T05:00","2024-02-28T06:00","2024-02-28T07:00","2024-02-28T08:00","2024-02-28T09:00","2024-02-28T10:00","2024-02-28T11:00","2024-02-28T12:00","2024-02-28T13:00","2024-02-28T14:00","2024-02-28T15:00","2024-02-28T16:00","2024-02-28T17:00","2024-02-28T18:00","2024-02-28T19:00","2024-02-28T20:00","2024-02-28T21:00","2024-02-28T22:00","2024-02-28T23:00","2024-02-29T00:00","2024-02-29T01:00","2024-02-29T02:00","2024-02-29T03:00","2024-02-29T04:00","2024-02-29T05:00","2024-02-29T06:00","2024-02-29T07:00","2024-02-29T08:00","2024-02-29T09:00","2024-02-29T10:00","2024-02-29T11:00","2024-02-29T12:00","2024-02-29T13:00","2024-02-29T14:00","2024-02-29T15:00","2024-02-29T16:00","2024-02-29T17:00","2024-02-29T18:00","2024-02-29T19:00","2024-02-29T20:00","2024-02-29T21:00","2024-02-29T22:00","2024-02-29T23:00","2024-03-01T00:00","2024-03-01T01:00","2024-03-01T02:00","2024-03-01T03:00","2024-03-01T04:00","2024-03-01T05:00","2024-03-01T06:00","2024-03-01T07:00","2024-03-01T08:00","2024-03-01T09:00","2024-03-01T10:00","2024-03-01T11:00","2024-03-01T12:00","2024-03-01T13:00","2024-03-01T14:00","2024-03-01T15:00","2024-03-01T16:00","2024-03-01T17:00","2024-03-01T18:00","2024-03-01T19:00","2024-03-01T20:00","2024-03-01T21:00","2024-03-01T22:00","2024-03-01T23:00"],"temperature_2m":[3.2,3.0,2.2,1.9,1.3,1.2,1.0,1.1,1.9,4.8,6.5,8.8,10.8,11.1,10.8,10.4,9.8,8.5,8.1,7.5,6.8,6.6,5.9,5.3,5.1,4.5,4.4,4.3,4.3,3.9,3.3,3.3,4.2,5.0,5.8,6.2,5.8,6.1,6.3,5.8,5.4,5.2,4.8,4.7,4.6,4.2,4.1,3.9,3.7,3.7,3.7,3.5,3.4,3.4,3.3,3.3,3.5,3.0,3.4,4.4,3.4,3.6,4.2,4.5,4.5,3.9,2.6,1.9,1.4,0.7,0.5,0.3,-0.3,-0.5,-0.7,-0.6,-0.6,-0.8,-0.8,-0.8,0.0,2.4,4.7,6.7,8.3,9.1,9.2,9.3,8.8,8.0,7.9,7.4,6.9,7.1,7.1,6.9,6.4,6.0,6.0,6.6,6.6,6.6,6.8,6.8,6.8,7.1,7.9,8.9,9.5,10.2,10.6,9.9,9.7,9.0,8.0,7.4,6.9,6.7,7.0,7.1],"apparent_temperature":[0.9,0.4,-0.4,-0.8,-1.6,-1.7,-1.8,-1.8,-1.0,1.9,3.6,6.0,7.5,7.9,7.6,7.1,6.7,5.5,5.3,4.5,3.4,3.4,2.7,2.0,1.8,1.2,1.1,1.1,1.1,0.5,-0.2,0.1,0.5,1.6,2.7,2.8,2.6,2.9,3.1,2.7,2.6,2.4,2.2,2.1,1.9,1.5,1.4,1.2,1.1,1.1,1.2,0.7,0.7,0.6,0.4,-0.0,0.2,-0.3,0.0,1.0,-0.1,0.6,1.4,1.7,1.7,1.1,-0.1,-0.9,-1.6,-2.5,-2.6,-3.1,-4.0,-3.8,-3.9,-4.0,-4.2,-4.4,-4.5,-4.7,-3.9,-1.5,0.8,3.1,4.9,5.7,5.9,5.5,5.5,4.6,4.3,4.3,4.1,4.2,4.4,4.5,4.1,3.9,3.6,4.3,4.4,4.4,4.7,4.7,4.6,4.9,5.7,6.7,7.3,8.1,8.7,7.7,7.8,7.5,6.6,5.8,5.3,5.0,5.5,5.7],"precipitation":[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.10],"rain":[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.10],"showers":[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],"snowfall":[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],"snow_depth":[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00]}}
        """
    }
}